<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ビジネス英語ドリル</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        body { touch-action: manipulation; }
        .btn:focus { outline: none; ring: 3px; ring-offset: 2px; }
        .btn { transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; }
        .btn:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- ランク選択画面 -->
    <div id="rank-selection-view" class="w-full max-w-lg mx-auto p-4">
        <header class="text-center py-4">
            <h1 class="text-2xl font-bold">ビジネス英語ドリル</h1>
            <p class="text-gray-600 mt-1">挑戦する重要度ランクを選択してください</p>
        </header>

        <main id="rank-list" class="grid grid-cols-1 gap-4">
            <!-- JavaScriptによってランクボタンがここに挿入されます -->
        </main>
        
        <div class="mt-6 text-center">
             <button id="random-drill-btn" class="btn bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700">
                腕試し！全範囲からランダム演習
            </button>
        </div>
    </div>

    <!-- 練習画面 (最初は非表示) -->
    <div id="drill-view" class="w-full max-w-lg mx-auto p-4 flex-col h-screen hidden">
        <header class="text-center py-4 flex items-center">
            <button id="back-to-ranks-btn" class="btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300">&lt; 戻る</button>
            <h1 id="drill-title" class="text-xl font-bold flex-grow"></h1>
        </header>

        <main class="flex-grow flex flex-col justify-center">
            <div id="quiz-area" class="bg-white rounded-xl shadow-lg p-6 min-h-[150px] flex justify-center items-center mb-6">
                <p id="japanese-sentence" class="text-xl md:text-2xl font-medium text-center"></p>
            </div>
            <div id="answer-area" class="bg-blue-100 border-2 border-dashed border-blue-300 rounded-xl p-6 min-h-[100px] flex justify-center items-center mb-8 opacity-0 transition-opacity duration-300">
                <p id="english-sentence" class="text-lg md:text-xl font-bold text-blue-800 text-center"></p>
            </div>
        </main>

        <footer class="py-4">
            <button id="action-btn" class="btn w-full bg-blue-500 text-white font-bold py-4 rounded-lg shadow-md hover:bg-blue-600 transition-all focus:ring-blue-400">
                答えを見る
            </button>
        </footer>
    </div>

    <script>
        // サービスワーカーの登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }
    </script>
    
    <script src="database.js"></script>
    
    <script>
        // --- DOM要素の取得 ---
        const rankSelectionView = document.getElementById('rank-selection-view');
        const drillView = document.getElementById('drill-view');
        const rankList = document.getElementById('rank-list');
        const drillTitle = document.getElementById('drill-title');
        const backToRanksBtn = document.getElementById('back-to-ranks-btn');
        const japaneseSentenceEl = document.getElementById('japanese-sentence');
        const englishSentenceEl = document.getElementById('english-sentence');
        const answerAreaEl = document.getElementById('answer-area');
        const actionBtn = document.getElementById('action-btn');
        const randomDrillBtn = document.getElementById('random-drill-btn');

        // --- アプリの状態管理 ---
        let questionList = [];
        let currentQuestionIndex = 0;
        let isAnswerShown = false;
        let drillState = 'idle';
        
        const RANKS = [
            { id: 'S', name: 'Rank S (最重要)', description: 'これだけは押さえたい必須表現' },
            { id: 'A', name: 'Rank A (高頻度)', description: '日常業務で頻繁に使う表現' },
            { id: 'B', name: 'Rank B (応用)', description: '差がつく丁寧・応用表現' },
            { id: 'C', name: 'Rank C (発展)', description: '交渉やプレゼンで役立つ高度な表現' },
        ];

        // --- 初期化処理 ---
        function initialize() {
            renderRankSelection();
            actionBtn.addEventListener('click', onActionBtnClick);
            backToRanksBtn.addEventListener('click', showRankSelectionView);
            randomDrillBtn.addEventListener('click', () => startPractice({ type: 'random' }));
        }

        // --- 画面描画 ---
        function renderRankSelection() {
            rankList.innerHTML = '';
            const allSentences = Object.values(sentenceDatabase).flat();

            RANKS.forEach(rank => {
                const sentencesInRank = allSentences.filter(s => s.rank === rank.id);
                const totalInRank = sentencesInRank.length;

                const button = document.createElement('button');
                button.className = "btn text-left p-4 rounded-lg shadow transition-all";
                button.dataset.type = 'rank';
                button.dataset.value = rank.id;

                if (totalInRank > 0) {
                    button.classList.add('bg-white', 'hover:bg-gray-50', 'hover:shadow-md');
                    button.innerHTML = `
                        <div class="font-bold text-xl text-blue-600">${rank.name}</div>
                        <div class="text-sm text-gray-600 mt-1">${rank.description}</div>
                        <div class="text-xs text-gray-500 mt-2">例文: ${totalInRank}件</div>
                    `;
                } else {
                    button.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
                    button.innerHTML = `
                        <div class="font-bold text-xl text-gray-400">${rank.name}</div>
                        <div class="text-sm text-gray-400 mt-1">（準備中）</div>
                    `;
                    button.disabled = true;
                }
                rankList.appendChild(button);
            });
        }
        
        // --- 画面遷移 ---
        function showDrillView(title) {
            rankSelectionView.classList.add('hidden');
            drillView.classList.remove('hidden');
            drillView.classList.add('flex');
            drillTitle.textContent = title;
        }

        function showRankSelectionView() {
            drillState = 'idle';
            drillView.classList.add('hidden');
            drillView.classList.remove('flex');
            rankSelectionView.classList.remove('hidden');
            renderRankSelection();
        }

        // --- イベントリスナー ---
        rankList.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (button && !button.disabled) {
                const type = button.dataset.type;
                const value = button.dataset.value;
                startPractice({ type, value });
            }
        });

        function onActionBtnClick() {
            if (drillState === 'drilling') {
                handleDrillAction();
            } else if (drillState === 'finished') {
                showRankSelectionView();
            }
        }

        // --- メインロジック ---
        function startPractice(drillInfo) {
            drillState = 'drilling';
            let sourceSentences = [];
            let drillTitleText = '';

            const allSentences = Object.values(sentenceDatabase).flat();

            if (drillInfo.type === 'rank') {
                sourceSentences = allSentences.filter(s => s.rank === drillInfo.value);
                const rankInfo = RANKS.find(r => r.id === drillInfo.value);
                drillTitleText = rankInfo.name;
            } else { // type === 'random'
                sourceSentences = allSentences;
                drillTitleText = 'ランダム総合演習';
            }
            
            if (sourceSentences.length === 0) {
                alert("このカテゴリにはまだ例文がありません。");
                return;
            }

            const shuffled = sourceSentences.sort(() => Math.random() - 0.5);
            questionList = shuffled.slice(0, 20);
            
            currentQuestionIndex = 0;
            displayQuestion();
            showDrillView(drillTitleText);
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questionList.length) {
                finishPractice();
                return;
            }
            const question = questionList[currentQuestionIndex];
            japaneseSentenceEl.textContent = question.jp;
            englishSentenceEl.textContent = question.en;
            
            isAnswerShown = false;
            answerAreaEl.classList.add('opacity-0');
            actionBtn.textContent = '答えを見る';
            actionBtn.classList.remove('bg-gray-700');
            actionBtn.classList.add('bg-blue-500');
        }

        function handleDrillAction() {
            if (!isAnswerShown) {
                answerAreaEl.classList.remove('opacity-0');
                isAnswerShown = true;
                actionBtn.textContent = '次の問題へ';
                actionBtn.classList.remove('bg-blue-500');
                actionBtn.classList.add('bg-gray-700');
            } else {
                currentQuestionIndex++;
                displayQuestion();
            }
        }
        
        function finishPractice() {
            drillState = 'finished';
            japaneseSentenceEl.textContent = "セッション完了！お疲れ様でした！";
            actionBtn.textContent = "ランク選択へ戻る";
        }

        // アプリケーションの初期化
        initialize();
    </script>
</body>
</html>
